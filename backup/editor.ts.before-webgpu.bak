import * as monaco from 'monaco-editor';
import loader from '@monaco-editor/loader';
import type { editor } from 'monaco-editor';
import * as ts from 'typescript';

let editorInstance: editor.IStandaloneCodeEditor | null = null;
let consoleElement: HTMLDivElement | null = null;

export function setConsoleOutput(element: HTMLDivElement): void {
  consoleElement = element;
}

function logToConsole(message: string, type: 'log' | 'error' | 'warn' = 'log'): void {
  if (!consoleElement) return;

  const line = document.createElement('div');
  line.className = `console-line console-${type}`;
  line.textContent = message;
  consoleElement.appendChild(line);
  consoleElement.scrollTop = consoleElement.scrollHeight;
}

function clearConsole(): void {
  if (!consoleElement) return;
  consoleElement.innerHTML = '';
}

export async function initializeEditor(): Promise<editor.IStandaloneCodeEditor> {
  loader.config({ monaco });

  await loader.init();

  // Create editor
  const editorContainer = document.getElementById('monaco-editor');
  if (!editorContainer) {
    throw new Error('Monaco editor container not found');
  }

  const editor = monaco.editor.create(editorContainer, {
    value: getInitialCode(),
    language: 'typescript',
    theme: 'vs-dark',
    automaticLayout: true,
    minimap: { enabled: false },
    fontSize: 14,
    lineNumbers: 'on',
    scrollBeyondLastLine: false,
    wordWrap: 'on',
  });

  editorInstance = editor;
  return editor;
}

export function getEditorInstance(): editor.IStandaloneCodeEditor | null {
  return editorInstance;
}

/**
 * Transpile TypeScript code to JavaScript using TypeScript compiler
 */
function transpileTypeScript(tsCode: string): {
  jsCode: string;
  errors: Array<{ line: number; message: string }>;
} {
  // Transpile to ES module
  const result = ts.transpileModule(tsCode, {
    compilerOptions: {
      module: ts.ModuleKind.CommonJS,
      target: ts.ScriptTarget.ES2022,
      jsx: ts.JsxEmit.Preserve,
      isolatedModules: true,
      esModuleInterop: true,
    },
    reportDiagnostics: true,
  });

  // Extract diagnostics (errors)
  const errors: Array<{ line: number; message: string }> = [];

  if (result.diagnostics) {
    for (const diagnostic of result.diagnostics) {
      const message = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
      const lineMatch = message.match(/\((\d+),\d+\)/);
      const line = lineMatch ? parseInt(lineMatch[1]) : 1;
      errors.push({ line, message });
    }
  }

  return { jsCode: result.outputText, errors };
}

export async function executeCode(code: string): Promise<void> {
  try {
    clearConsole();

    // Transpile TypeScript to JavaScript
    const { jsCode, errors } = transpileTypeScript(code);

    // If there are compilation errors, show the first one
    if (errors.length > 0) {
      const firstError = errors[0];
      throw new Error(`Line ${firstError.line}: ${firstError.message}`);
    }

    // Capture console output
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = (...args) => {
      logToConsole(args.map(a => String(a)).join(' '), 'log');
      originalLog.apply(console, args);
    };

    console.error = (...args) => {
      logToConsole(args.map(a => String(a)).join(' '), 'error');
      originalError.apply(console, args);
    };

    console.warn = (...args) => {
      logToConsole(args.map(a => String(a)).join(' '), 'warn');
      originalWarn.apply(console, args);
    };

    try {
      // Execute the transpiled code
      // Strip imports and exports for execution in Function context
      const executableCode = jsCode
        .replace(/import\s+.*?\s+from\s+['"].*?['"];?\s*/g, '')
        .replace(/export\s+/g, '');

      const runCode = new Function(executableCode);
      runCode();

      // Hide any previous error messages
      const errorElement = document.getElementById('error-message') as HTMLDivElement;
      if (errorElement) {
        errorElement.classList.add('hidden');
        errorElement.textContent = '';
      }
    } finally {
      // Restore console methods
      console.log = originalLog;
      console.error = originalError;
      console.warn = originalWarn;
    }
  } catch (error) {
    console.error('Failed to execute code:', error);

    // Show error in console
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    logToConsole(`Error: ${errorMessage}`, 'error');

    // Show error in error banner
    const errorElement = document.getElementById('error-message') as HTMLDivElement;
    if (errorElement) {
      let displayMessage = errorMessage;
      let lineNumber: string | null = null;

      if (errorMessage.includes('Line ')) {
        const lineMatch = errorMessage.match(/Line (\d+):/);
        if (lineMatch) {
          lineNumber = lineMatch[1];
          const errorWithoutLine = errorMessage.replace(/Line \d+:/, '').trim();
          displayMessage = `<span class="error-line-number">Line ${lineNumber}</span><span class="error-message">${errorWithoutLine}</span>`;

          // Highlight the line in the editor if possible
          const editor = getEditorInstance();
          if (editor) {
            const lineIndex = parseInt(lineNumber);
            editor.setPosition({ lineNumber: lineIndex, column: 1 });
            editor.revealLineInCenter(lineIndex);
            editor.focus();
          }
        }
      } else {
        displayMessage = `<span class="error-message">Error: ${errorMessage}</span>`;
      }

      errorElement.innerHTML = displayMessage;
      errorElement.classList.remove('hidden');
    }
  }
}

function getInitialCode(): string {
  return (
    '// TypeScript Editor\n' +
    '// Type your TypeScript code below and see the output in the console\n' +
    '\n' +
    '// Example: Simple calculator\n' +
    'function add(a: number, b: number): number {\n' +
    '  return a + b;\n' +
    '}\n' +
    '\n' +
    'function multiply(a: number, b: number): number {\n' +
    '  return a * b;\n' +
    '}\n' +
    '\n' +
    '// Try it out!\n' +
    'console.log("2 + 3 =", add(2, 3));\n' +
    'console.log("4 * 5 =", multiply(4, 5));\n' +
    '\n' +
    '// You can also define classes\n' +
    'class Greeter {\n' +
    '  name: string;\n' +
    '  \n' +
    '  constructor(name: string) {\n' +
    '    this.name = name;\n' +
    '  }\n' +
    '  \n' +
    '  greet(): void {\n' +
    '    console.log(`Hello, ${this.name}!`);\n' +
    '  }\n' +
    '}\n' +
    '\n' +
    'const greeter = new Greeter("World");\n' +
    'greeter.greet();'
  );
}
