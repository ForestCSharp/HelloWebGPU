import {
  initializeEditor,
  executeRenderCode,
  setRenderer,
  getHasValidCode,
  clearCanvas,
} from './editor';
import { Renderer } from './webgpu/renderer';
import { createGPUContext } from './webgpu/utils';

async function main(): Promise<void> {
  try {
    const canvas = document.getElementById('webgpu-canvas') as HTMLCanvasElement;
    const errorElement = document.getElementById('error-message') as HTMLDivElement;

    if (!canvas || !errorElement) {
      throw new Error('Required DOM elements not found');
    }

    // Set canvas size
    canvas.width = 600;
    canvas.height = 450;

    // Initialize WebGPU context
    const gpuContext = await createGPUContext(canvas);

    // Create a minimal renderer (won't render until user code is valid)
    const renderer = new Renderer(gpuContext);

    // Store renderer instance for editor
    setRenderer(renderer);

    // Initialize editor
    const editor = await initializeEditor();

    // Set up live execution on code changes
    editor.onDidChangeModelContent(() => {
      const code = editor.getValue();
      executeRenderCode(code);
    });

    // Execute initial code
    const initialCode = editor.getValue();
    await executeRenderCode(initialCode);

    // Start render loop - only render when code is valid
    function renderLoop(): void {
      try {
        if (getHasValidCode()) {
          renderer.render();
        } else {
          // Canvas stays cleared when code is invalid
          clearCanvas();
        }
      } catch (error) {
        console.error('Render loop error:', error);
        errorElement.textContent = `Render Error: ${error instanceof Error ? error.message : 'Unknown error'}`;
        errorElement.classList.remove('hidden');
      }
      requestAnimationFrame(renderLoop);
    }

    renderLoop();
  } catch (error) {
    console.error('Failed to initialize:', error);
    const errorElement = document.getElementById('error-message') as HTMLDivElement;
    if (errorElement) {
      errorElement.textContent = `Error: ${error instanceof Error ? error.message : 'Unknown error'}`;
      errorElement.classList.remove('hidden');
    }
  }
}

main().catch(console.error);
